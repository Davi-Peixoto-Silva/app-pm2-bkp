<!DOCTYPE html>
<html lang="pt-BR">
  <head>
    <meta charset="UTF-8" />
    <link rel="icon" href="https://santelisa.com.br/wp-content/themes/2024_santelisa/assets/ico/favicon-32x32.png">
    <title>Dashboard</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.datatables.net/1.13.6/css/dataTables.bootstrap5.min.css">
    <link rel="stylesheet" href="https://cdn.datatables.net/buttons/2.4.2/css/buttons.bootstrap5.min.css">
    <link rel="stylesheet" href="/css/painel_faturamento.css" />
  </head>
<body class="container py-4">

<!-- Título com ícone e botões à direita -->
<div class="d-flex justify-content-between align-items-center flex-wrap gap-3 mb-4">
  <div class="d-flex align-items-center gap-2">
    <i class="bi bi-bar-chart-fill fs-3 text-primary"></i>
    <h5 class="m-0 fw-bold">Dashboard Faturamento  <small class="text-muted fs-6">(<%= titulo %>)</small> <small class="text-muted fs-6">(<%= tituloComparativo %>)</small></h5>
    
  </div>

  <div class="d-flex flex-wrap gap-2">
    <a href="javascript:history.back()" class="btn btn-outline-secondary">
      <i class="bi bi-arrow-left"></i> Voltar
    </a>
    <button class="btn btn-outline-primary" data-bs-toggle="modal" data-bs-target="#modalResumoLogistica">
      <i class="bi bi-truck"></i> Resumo Logístico
    </button>
    <button class="btn btn-outline-secondary" data-bs-toggle="modal" data-bs-target="#modalResumoFaturamento">
      <i class="bi bi-calendar3"></i> Evolução por Dia
    </button>
  </div>
</div>

  <!-- KPIs -->
  <div class="kpi-container mb-5 d-flex flex-wrap gap-3 justify-content-start">
    <%
      const safe = (val) => typeof val === 'number' ? val : 0;
      const k = {
        faturamento: safe(kpis.faturamento),
        metaValor: safe(kpis.metaValor),
        pctFaturamento: safe(kpis.pctFaturamento),
        pctFaturamentoMeta: safe(kpis.pctFaturamentoMeta),
        volume: safe(kpis.volume),
        metaVolume: safe(kpis.metaVolume),
        pctVolume: safe(kpis.pctVolume),
        pctPesoMeta: safe(kpis.pctPesoMeta),
        precoMedio: safe(kpis.precoMedio),
        metaPrecoMedio: safe(kpis.metaPrecoMedio),
        precoMedioMesAnterior: safe(kpis.precoMedioMesAnterior),
        precoMedioAnterior: safe(kpis.precoMedioAnterior),
        pctPrecoMedio: safe(kpis.pctPrecoMedio),
        pctPrecoMedioMeta: safe(kpis.pctPrecoMedioMeta),
        mesAnteriorValor: safe(kpis.mesAnteriorValor),
        mesAnteriorPeso: safe(kpis.mesAnteriorPeso),
        evolucaoFaturamento: safe(kpis.evolucaoFaturamento),
        evolucaoPeso: safe(kpis.evolucaoPeso),
        evolucaoCarteira: safe(kpis.evolucaoCarteira),
        carteira: safe(kpis.carteira),
        carteiraAnterior: safe(kpis.carteiraAnterior)
      };
    
      const kpiCards = [
        {
          icon: 'bi-cash-coin',
          label: 'Faturamento (R$.1000)',
          value: `R$ ${k.faturamento.toLocaleString('pt-BR', { minimumFractionDigits: 1 })}`,
          footer: `Meta: R$ ${k.metaValor.toLocaleString('pt-BR')} | <span class="${k.pctFaturamento >= 100 ? 'text-positive' : 'text-negative'}">${k.pctFaturamento.toFixed(2).replace('.', ',')}%</span>`
        },
        {
          icon: 'bi-truck',
          label: 'Volume (ton)',
          value: `${k.volume.toLocaleString('pt-BR', { minimumFractionDigits: 1 })}`,
          footer: `Meta: ${k.metaVolume.toLocaleString('pt-BR')} | <span class="${k.pctVolume >= 100 ? 'text-positive' : 'text-negative'}">${k.pctVolume.toFixed(2).replace('.', ',')}%</span>`
        },
        {
          icon: 'bi-graph-up',
          label: 'Preço Médio Atual',
          value: `R$ ${k.precoMedio.toLocaleString('pt-BR', { minimumFractionDigits: 1 })}`,
          footer: `Meta: R$ ${k.metaPrecoMedio.toLocaleString('pt-BR')} | <span class="${k.pctPrecoMedioMeta >= 0 ? 'text-positive' : 'text-negative'}">${k.pctPrecoMedioMeta.toFixed(2).replace('.', ',')}%</span>`
        },
        {
          icon: 'bi-box-seam',
          label: 'Carteira de Pedidos',
          value: `${k.carteira.toLocaleString('pt-BR', { minimumFractionDigits: 1 })} ton`,
          footer: `Anterior: ${k.carteiraAnterior.toLocaleString('pt-BR', { minimumFractionDigits: 2 })} ton | <span class="${k.evolucaoCarteira >= 0 ? 'text-positive' : 'text-negative'}">${k.evolucaoCarteira.toFixed(2).replace('.', ',')}%</span>`
        },        
        {
          icon: 'bi-bar-chart',
          label: `Evolução Faturamento (${tituloComparativo})`,
          value: `R$ ${k.mesAnteriorValor.toLocaleString('pt-BR', { minimumFractionDigits: 1 })}`,
          footer: `Atual: R$ ${k.faturamento.toLocaleString('pt-BR')} | <span class="${k.evolucaoFaturamento >= 0 ? 'text-positive' : 'text-negative'}">${k.evolucaoFaturamento.toFixed(2).replace('.', ',')}%</span>`
        },
        {
          icon: 'bi-graph-down',
          label: `Evolução Peso (${tituloComparativo})`,
          value: `R$ ${k.mesAnteriorPeso.toLocaleString('pt-BR', { minimumFractionDigits: 1 })}`,
          footer: `Atual: ${k.volume.toLocaleString('pt-BR')} | <span class="${k.evolucaoPeso >= 0 ? 'text-positive' : 'text-negative'}">${k.evolucaoPeso.toFixed(2).replace('.', ',')}%</span>`
        },
        {
          icon: 'bi-graph-up-arrow',
          label: `Evolução Preço Médio (${tituloComparativo})`,
          value: `R$ ${k.precoMedioMesAnterior.toLocaleString('pt-BR', { minimumFractionDigits: 1 })}`,
          footer: `Atual: R$ ${k.precoMedio.toLocaleString('pt-BR')} | <span class="${k.pctPrecoMedio >= 0 ? 'text-positive' : 'text-negative'}">${k.pctPrecoMedio.toFixed(2).replace('.', ',')}%</span>`
        }
      ];
    %>
    
    <% kpiCards.forEach(kpi => { %>
      <div class="kpi-card">
        <div class="kpi-icon"><i class="bi <%= kpi.icon %>"></i></div>
        <div class="kpi-label"><%= kpi.label %></div>
        <div class="kpi-value <%= kpi.valueClass || '' %>"><%- kpi.value %></div>
        <div class="kpi-footer"><%- kpi.footer %></div>
      </div>
    <% }); %>
    </div>

  <!-- MODAL: Resumo Logístico -->
  <div class="modal fade" id="modalResumoLogistica" tabindex="-1" aria-labelledby="modalResumoLogisticaLabel" aria-hidden="true">
    <div class="modal-dialog modal-xl modal-dialog-scrollable">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="modalResumoLogisticaLabel">Resumo Logístico</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body">
          <table id="tabelaResumoLog" class="table table-bordered table-hover w-100">
            <thead class="table-light text-center">
              <tr>
                <th>Indicador</th>
                <th>Mês Atual</th>
                <th>Mês Anterior</th>
                <th>Evolução (%)</th>
              </tr>
            </thead>
            <tbody class="text-end">
              <% const calcPct = (atual, anterior) => {
                   if (!anterior || anterior === 0) return '-';
                   const pct = ((atual - anterior) / anterior) * 100;
                   return (pct >= 0 ? '+' : '') + pct.toFixed(1).replace('.', ',') + '%';
              }; %>
              <tr><td class="text-start">Dias Úteis</td><td><%= resumoLogistica.atual.diasUteis %></td><td><%= resumoLogistica.anterior.diasUteis %></td><td>-</td></tr>
              <tr><td class="text-start">Qtd Embarques</td><td><%= resumoLogistica.atual.qtdEmbarques %></td><td><%= resumoLogistica.anterior.qtdEmbarques %></td><td><%= calcPct(resumoLogistica.atual.qtdEmbarques, resumoLogistica.anterior.qtdEmbarques) %></td></tr>
              <tr><td class="text-start">Ton. Embarcadas</td><td><%= resumoLogistica.atual.toneladas.toFixed(3) %></td><td><%= resumoLogistica.anterior.toneladas.toFixed(3) %></td><td><%= calcPct(resumoLogistica.atual.toneladas, resumoLogistica.anterior.toneladas) %></td></tr>
              <tr><td class="text-start">Embarques por Dia</td><td><%= resumoLogistica.atual.embarquesDia.toFixed(1) %></td><td><%= resumoLogistica.anterior.embarquesDia.toFixed(1 ) %></td><td><%= calcPct(resumoLogistica.atual.embarquesDia, resumoLogistica.anterior.embarquesDia) %></td>
              </tr>
              
              <tr><td class="text-start">Qtd Clientes</td><td><%= resumoLogistica.atual.qtdClientes %></td><td><%= resumoLogistica.anterior.qtdClientes %></td><td><%= calcPct(resumoLogistica.atual.qtdClientes, resumoLogistica.anterior.qtdClientes) %></td></tr>
              <tr><td class="text-start">Qtd SKUs</td><td><%= resumoLogistica.atual.qtdSKUs %></td><td><%= resumoLogistica.anterior.qtdSKUs %></td><td><%= calcPct(resumoLogistica.atual.qtdSKUs, resumoLogistica.anterior.qtdSKUs) %></td></tr>
            </tbody>
          </table>
        </div>
      </div>
    </div>
  </div>

  <!-- MODAL: Evolução por Dia -->
  <div class="modal fade" id="modalResumoFaturamento" tabindex="-1" aria-labelledby="modalResumoFaturamentoLabel" aria-hidden="true">
    <div class="modal-dialog modal-xl modal-dialog-scrollable">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="modalResumoFaturamentoLabel">Tendência de Faturamento por Dia</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body">
          <table id="tabelaResumo" class="table table-bordered table-hover align-middle">
            <thead class="table-light">
              <tr>
                <th>Data</th>
                <th>Faturamento (R$)</th>
                <th>Peso Líquido (kg)</th>
                <th>Preço Médio (R$/kg)</th>
              </tr>
            </thead>
            <tbody></tbody>
            <tfoot class="table-light">
              <tr><td colspan="3" class="text-end">Média Faturamento</td><td id="mediaFaturamento"></td></tr>
              <tr><td colspan="3" class="text-end">Média Peso Líquido</td><td id="mediaPeso"></td></tr>
            </tfoot>
          </table>
        </div>
      </div>
    </div>
  </div>

  <footer class="text-center mt-5 text-muted small">
    &copy; <%= new Date().getFullYear() %> Sistema Integrado Santelisa
  </footer>
  

  <!-- Scripts -->
  <script src="https://code.jquery.com/jquery-3.7.0.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
  <script src="https://cdn.datatables.net/1.13.6/js/jquery.dataTables.min.js"></script>
  <script src="https://cdn.datatables.net/1.13.6/js/dataTables.bootstrap5.min.js"></script>
  <script src="https://cdn.datatables.net/buttons/2.4.2/js/dataTables.buttons.min.js"></script>
  <script src="https://cdn.datatables.net/buttons/2.4.2/js/buttons.bootstrap5.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/pdfmake/0.2.7/pdfmake.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/pdfmake/0.2.7/vfs_fonts.js"></script>
  <script src="https://cdn.datatables.net/buttons/2.4.2/js/buttons.html5.min.js"></script>
  <script src="https://cdn.datatables.net/buttons/2.4.2/js/buttons.print.min.js"></script>

  <!-- Dados do resumo para o JS -->
  <script>
    const resumo = <%- JSON.stringify(resumo) %>;
  </script>

  <!-- Seu script principal -->
  <script defer src="/js/painel_faturamento.js"></script>
</body>
</html>