<!DOCTYPE html>
<html lang="pt-br">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title><%= titulo %></title>
  <link rel="icon" href="https://santelisa.com.br/wp-content/themes/2024_santelisa/assets/ico/favicon-32x32.png" />
  
  <!-- Estilos Bootstrap/DataTables/Icons -->
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" />
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css" />
  <link href="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/css/select2.min.css" rel="stylesheet" />
  
  <link rel="stylesheet" href="https://cdn.datatables.net/2.1.8/css/dataTables.bootstrap5.css" />
  <link rel="stylesheet" href="https://cdn.datatables.net/buttons/3.2.0/css/buttons.bootstrap5.css" />
  <link rel="stylesheet" href="https://cdn.datatables.net/colreorder/2.0.4/css/colReorder.bootstrap5.css" />
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/datatables.net-colresize-unofficial@latest/jquery.dataTables.colResize.css" />
  
  <link rel="stylesheet" href="/css/relatorios.css" />
</head>

<body>

<!-- Navbar -->
<nav class="navbar navbar-expand-lg navbar-dark bg-success shadow-sm px-3">
  <div class="container-fluid">
    <span class="navbar-brand d-flex align-items-center gap-2">
      <i class="bi bi-table fs-5"></i> <span><%= titulo %></span>
    </span>

    <div class="d-flex flex-wrap align-items-center justify-content-end gap-3 ms-auto">
      <!-- Cálculo -->
      <div class="d-flex align-items-center">
        <label for="tipoCalculo" class="text-white me-2 mb-0 small">Cálculo:</label>
        <select id="tipoCalculo" class="form-select form-select-sm">
          <option value="soma">Soma</option>
          <option value="média">Média</option>
          <option value="contagem">Contagem</option>
          <option value="máximo">Máximo</option>
          <option value="mínimo">Mínimo</option>
          <option value="moda">Moda</option>
        </select>
      </div>

      <!-- Coluna -->
      <div class="d-flex align-items-center">
        <label for="colunaCalculo" class="text-white me-2 mb-0 small">Coluna:</label>
        <select id="colunaCalculo" class="form-select form-select-sm">
          <!-- Preenchido dinamicamente -->
        </select>
      </div>

      <!-- Resultado -->
      <div id="somaResultado" class="badge text-bg-light text-success fs-6 rounded-pill px-3 py-2 shadow-sm">
        <i class="bi bi-calculator-fill me-1"></i>
        Resultado: 0
      </div>

      <!-- Exportar -->
      <div class="btn-group">
        <button class="btn btn-outline-light btn-sm dropdown-toggle" data-bs-toggle="dropdown">
          <i class="bi bi-download"></i> Exportar
        </button>
        <ul class="dropdown-menu dropdown-menu-end">
          <li><button class="dropdown-item" onclick="$('#tabelaRelatorio').DataTable().button('.buttons-copy').trigger()">Copiar</button></li>
          <!-- <li><button class="dropdown-item" onclick="$('#tabelaRelatorio').DataTable().button('.buttons-excel').trigger()">Excel</button></li> -->
          <li><button class="dropdown-item" onclick="$('#tabelaRelatorio').DataTable().button('.buttons-pdf').trigger()">PDF</button></li>
          <li><button class="dropdown-item" onclick="$('#tabelaRelatorio').DataTable().button('.buttons-print').trigger()">Imprimir</button></li>
        </ul>
      </div>

      <!-- Voltar -->
      <button class="btn btn-outline-light btn-sm" onclick="history.back()" title="Voltar">
        <i class="bi bi-arrow-left-circle"></i> Voltar
      </button>
    </div>
  </div>
</nav>

<!-- Tabela -->
<div class="container py-4">
  <div class="table-responsive shadow p-3 mb-5 bg-light rounded">
    <table id="tabelaRelatorio" class="table table-bordered table-hover w-100">
      <thead class="text-center table-success">
        <tr>
          <% colunas.forEach((col, index) => { %>
            <th class="position-relative align-middle">
              <span class="fw-bold"><%= col %></span>
              <button type="button"
                      id="btn-limpar-<%= index %>"
                      class="btn btn-link btn-sm p-0 text-danger d-none position-absolute top-0 end-0"
                      onclick="limparFiltroColunaCabecalho(<%= index %>)"
                      title="Limpar filtro">
                <i class="bi bi-x-circle-fill"></i>
              </button>
            </th>
          <% }) %>
        </tr>

        <!-- Linha de Filtros -->
        <tr class="filtros bg-white">
          <% colunas.forEach((col, index) => { %>
            <th>
              <select id="input-filtro-<%= index %>"
                      class="form-select form-select-sm filtro-coluna"
                      data-index="<%= index %>" multiple>
                <% 
                  const valoresUnicos = (typeof listaValoresUnicos !== 'undefined' && listaValoresUnicos[col]) 
                                        ? listaValoresUnicos[col] 
                                        : []; 
                  valoresUnicos.forEach(valor => { 
                %>
                  <option value="<%= valor %>"><%= valor %></option>
                <% }) %>
              </select>
            </th>
          <% }) %>
        </tr>
      </thead>

      <tbody>
        <% produtos.forEach((linha, indexLinha) => { %>
          <tr>
            <% colunas.forEach((col, indexColuna) => { %>
              <td title="<%= (linha[col] !== undefined && linha[col] !== null) ? linha[col] : '' %>">
                <% if (col.trim().toLowerCase() === 'observação comercial') { %>
                  <div class="d-flex align-items-center gap-2">
                    <input id="obs_<%= linha['Pedido'] ? linha['Pedido'] : 'SEM_PEDIDO' %>_<%= indexLinha %>"
                           class="form-control form-control-sm"
                           value="<%= (linha[col] !== undefined && linha[col] !== null) ? linha[col] : '' %>"
                           disabled />
                    <button class="btn btn-outline-primary btn-sm" onclick="habilitarEdicao('<%= linha['Pedido'] ? linha['Pedido'] : 'SEM_PEDIDO' %>_<%= indexLinha %>')" title="Editar">
                      <i class="bi bi-pencil"></i>
                    </button>
                    <button class="btn btn-success btn-sm d-none" onclick="confirmarESalvar('<%= linha['Pedido'] ? linha['Pedido'] : 'SEM_PEDIDO' %>_<%= indexLinha %>')" title="Salvar">
                      <i class="bi bi-save"></i>
                    </button>
                  </div>
                <% } else { %>
                  <%= (linha[col] !== undefined && linha[col] !== null) ? linha[col] : '' %>
                <% } %>
              </td>
            <% }) %>
          </tr>
        <% }) %>
      </tbody>
    </table>
  </div>
</div>

<!-- Botão flutuante de Voltar para mobile -->
<button onclick="history.back()" class="btn btn-success rounded-circle shadow position-fixed bottom-0 end-0 m-3 d-md-none" title="Voltar">
  <i class="bi bi-arrow-left-circle fs-4"></i>
</button>

<!-- Scripts -->
<script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/select2.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>

<script src="https://cdn.datatables.net/2.1.8/js/dataTables.js"></script>
<script src="https://cdn.datatables.net/2.1.8/js/dataTables.bootstrap5.js"></script>

<script src="https://cdn.datatables.net/buttons/3.2.0/js/dataTables.buttons.js"></script>
<script src="https://cdn.datatables.net/buttons/3.2.0/js/buttons.bootstrap5.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/pdfmake/0.2.7/pdfmake.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/pdfmake/0.2.7/vfs_fonts.js"></script>
<script src="https://cdn.datatables.net/buttons/3.2.0/js/buttons.html5.min.js"></script>
<script src="https://cdn.datatables.net/buttons/3.2.0/js/buttons.print.min.js"></script>
<script src="https://cdn.datatables.net/colreorder/2.0.4/js/dataTables.colReorder.js"></script>

<script src="https://cdn.jsdelivr.net/npm/datatables.net-colresize-unofficial@latest/jquery.dataTables.colResize.js"></script>

<script src="/js/relatorios.js"></script>

<script>
  // Ativa tooltips
  const tooltipTriggerList = document.querySelectorAll('[data-bs-toggle="tooltip"]');
  tooltipTriggerList.forEach(el => new bootstrap.Tooltip(el));

  // Ignora erros do Select2
  window.addEventListener("error", function (e) {
    if (e.message && e.message.includes("Cannot read properties of null (reading 'query')")) {
      console.warn("Erro do Select2 suprimido:", e.message);
      e.preventDefault();
      return false;
    }
  });
</script>

</body>
</html>
